# code: language=yaml
# yaml-language-server: $schema=../../.up/json/models/index.schema.json

{{ if $identityStoreId }}
  {{- range $user := $users }}
    {{- $username := $user.username }}
    {{- $resourceName := index $userResourceNames $username }}
    {{- if and $username $resourceName }}
      {{- $displayName := $user.displayName | default (trim (printf "%s %s" ($user.firstName | default "") ($user.lastName | default ""))) | default $username }}
      {{- $userLabels := merge (dict "hops.ops.com.ai/organization" $organizationName "aws.hops.ops.com.ai/identity-center-user" (regexReplaceAll "[^a-z0-9-]" (lower $username) "-")) ($user.tags | default (dict)) }}
      {{- $userMgmtPolicies := index $userManagementPolicies $username | default $managementPolicies }}
      {{- $userExtName := index $userExternalNames $username | default "" }}

---

apiVersion: identitystore.aws.m.upbound.io/v1beta1
kind: User
metadata:
  name: {{ $resourceName }}
  annotations:
    {{ setResourceNameAnnotation (printf "identity-center-user-%s" $username) }}
    {{- if $userExtName }}
    crossplane.io/external-name: {{ $userExtName | quote }}
    {{- end }}
  labels:
    {{- toYaml $userLabels | nindent 4 }}
spec:
  managementPolicies: {{ toYaml $userMgmtPolicies | nindent 4 }}
  forProvider:
    identityStoreId: {{ $identityStoreId }}
    displayName: {{ $displayName }}
    userName: {{ $username }}
    {{- if $region }}
    region: {{ $region }}
    {{- end }}
    name:
      {{- if $user.firstName }}
      givenName: {{ $user.firstName }}
      {{- else }}
      givenName: {{ $displayName }}
      {{- end }}
      {{- if $user.lastName }}
      familyName: {{ $user.lastName }}
      {{- end }}
    {{- if $user.email }}
    emails:
      value: {{ $user.email }}
      type: work
      primary: true
    {{- end }}
    {{- with $user.forProvider }}
    {{ toYaml . | nindent 4 }}
    {{- end }}
  providerConfigRef:
    kind: ProviderConfig
    name: {{ $providerConfigName }}

      {{- $userGroups := get $userGroupMemberships $username | default (list) }}
      {{- $membershipExternalNames := get $userGroupMembershipExternalNames $username | default (dict) }}
      {{- range $groupName := $userGroups }}
        {{- $groupResourceName := index $groupResourceNames $groupName }}
        {{- if $groupResourceName }}
          {{- $membershipSlug := regexReplaceAll "[^a-z0-9-]" (lower (printf "%s-%s" $username $groupName)) "-" }}
          {{- $membershipExternalName := index $membershipExternalNames $groupName | default "" }}

---

apiVersion: identitystore.aws.m.upbound.io/v1beta1
kind: GroupMembership
metadata:
  name: {{ printf "%s-ic-membership-%s" $organizationName $membershipSlug }}
  annotations:
    {{ setResourceNameAnnotation (printf "identity-center-group-membership-%s-%s" $username $groupName) }}
    {{- if $membershipExternalName }}
    crossplane.io/external-name: {{ $membershipExternalName | quote }}
    {{- end }}
spec:
  managementPolicies: {{ toYaml $userMgmtPolicies | nindent 4 }}
  forProvider:
    identityStoreId: {{ $identityStoreId }}
    memberIdRef:
      name: {{ $resourceName }}
    groupIdRef:
      name: {{ $groupResourceName }}
    {{- if $region }}
    region: {{ $region }}
    {{- end }}
  providerConfigRef:
    kind: ProviderConfig
    name: {{ $providerConfigName }}

        {{- end }}
      {{- end }}

    {{- end }}
  {{- end }}
{{ end }}
