# code: language=yaml
# yaml-language-server: $schema=../../.up/json/models/index.schema.json

{{ range $index, $permissionSet := $permissionSets }}
  {{- $permissionSetName := $permissionSet.name }}
  {{- if and $permissionSetName $identityCenterInstanceArn }}
    {{- $description := $permissionSet.description | default (printf "%s permission set for %s" $permissionSetName $organizationName) }}
    {{- $relayState := $permissionSet.relayState | default $identityCenterRelayState }}
    {{- $sessionDuration := $permissionSet.sessionDuration | default $identityCenterSessionDuration }}
    {{- $inlinePolicy := $permissionSet.inlinePolicy }}
    {{- $awsManagedPolicies := $permissionSet.managedPolicies | default (list) }}
    {{- $customerManagedPolicies := $permissionSet.customerManagedPolicies | default (list) }}
    {{- $permissionSetResourceName := index $permissionSetResourceNames $permissionSetName | default (printf "%s-%s" $organizationName (regexReplaceAll "[^a-z0-9-]" (lower $permissionSetName) "-")) }}
    {{- $permissionSetLabelValue := regexReplaceAll "[^a-z0-9-]" (lower $permissionSetName) "-" }}
    {{- $permissionSetLabels := dict "hops.ops.com.ai/organization" $organizationName "aws.hops.ops.com.ai/identity-center-permission-set" $permissionSetLabelValue }}
    {{- $permissionSetTags := merge $identityCenterTags ($permissionSet.tags | default (dict)) }}
    {{- $psMgmtPolicies := index $permissionSetManagementPolicies $permissionSetName | default $managementPolicies }}
    {{- $psExtName := index $permissionSetExternalNames $permissionSetName | default "" }}
    {{- $permissionSetReady := get $permissionSetReadyMap $permissionSetName | default false }}

---

apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
kind: PermissionSet
metadata:
  name: {{ $permissionSetResourceName }}
  annotations:
    {{ setResourceNameAnnotation (printf "permission-set-%s" $permissionSetName) }}
    {{- if $psExtName }}
    crossplane.io/external-name: {{ $psExtName | quote }}
    {{- end }}
  labels:
    {{- toYaml $permissionSetLabels | nindent 4 }}
spec:
  managementPolicies: {{ toYaml $psMgmtPolicies | nindent 4 }}
  forProvider:
    instanceArn: {{ $identityCenterInstanceArn }}
    name: {{ $permissionSetName }}
    description: {{ $description }}
    sessionDuration: {{ $sessionDuration }}
    {{- if $region }}
    region: {{ $region }}
    {{- end }}
    {{- if $relayState }}
    relayState: {{ $relayState }}
    {{- end }}
    {{- if $permissionSetTags }}
    tags:
      {{- toYaml $permissionSetTags | nindent 6 }}
    {{- end }}
    {{- with $permissionSet.forProvider }}
    {{ toYaml . | nindent 4 }}
    {{- end }}
  providerConfigRef:
    kind: ProviderConfig
    name: {{ $providerConfigName }}

    {{- if $inlinePolicy }}

---

apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
kind: PermissionSetInlinePolicy
metadata:
  name: {{ printf "%s-inline" $permissionSetResourceName }}
  annotations:
    {{ setResourceNameAnnotation (printf "permission-set-inline-policy-%s" $permissionSetName) }}
  labels:
    {{- toYaml $permissionSetLabels | nindent 4 }}
spec:
  managementPolicies: {{ toYaml $psMgmtPolicies | nindent 4 }}
  forProvider:
    instanceArn: {{ $identityCenterInstanceArn }}
    inlinePolicy: |
{{ $inlinePolicy | indent 6 }}
    permissionSetArnRef:
      name: {{ $permissionSetResourceName }}
    {{- if $region }}
    region: {{ $region }}
    {{- end }}
  providerConfigRef:
    kind: ProviderConfig
    name: {{ $providerConfigName }}

# Usage: PermissionSet protected by InlinePolicy
      {{- $inlineReady := get $inlinePolicyReadyMap $permissionSetName | default false }}
      {{- if and $permissionSetReady $inlineReady }}

---

apiVersion: protection.crossplane.io/v1beta1
kind: Usage
metadata:
  name: {{ printf "of-%s-by-%s-inline" $permissionSetResourceName $permissionSetResourceName }}
  annotations:
    {{ setResourceNameAnnotation (printf "permission-set-inline-policy-usage-%s" $permissionSetName) }}
spec:
  replayDeletion: true
  of:
    apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
    kind: PermissionSet
    resourceRef:
      name: {{ $permissionSetResourceName }}
  by:
    apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
    kind: PermissionSetInlinePolicy
    resourceRef:
      name: {{ printf "%s-inline" $permissionSetResourceName }}

      {{- end }}
    {{- end }}

    {{- range $awsManagedPolicy := $awsManagedPolicies }}
      {{- if $awsManagedPolicy }}
        {{- /* Extract policy name from ARN: arn:aws:iam::aws:policy/ReadOnlyAccess -> readonlyaccess */}}
        {{- $policySlug := regexReplaceAll "[^a-z0-9]" (lower (regexReplaceAll ".*/" $awsManagedPolicy "")) "" }}
        {{- $managedResourceName := printf "%s-managed-%s" $permissionSetResourceName $policySlug }}
        {{- $managedAnnotationKey := printf "permission-set-managed-policy-%s-%s" $permissionSetName $policySlug }}

---

apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
kind: ManagedPolicyAttachment
metadata:
  name: {{ $managedResourceName }}
  annotations:
    {{ setResourceNameAnnotation $managedAnnotationKey }}
  labels:
    {{- toYaml $permissionSetLabels | nindent 4 }}
spec:
  managementPolicies: {{ toYaml $psMgmtPolicies | nindent 4 }}
  forProvider:
    instanceArn: {{ $identityCenterInstanceArn }}
    managedPolicyArn: {{ $awsManagedPolicy }}
    permissionSetArnRef:
      name: {{ $permissionSetResourceName }}
    {{- if $region }}
    region: {{ $region }}
    {{- end }}
  providerConfigRef:
    kind: ProviderConfig
    name: {{ $providerConfigName }}

# Usage: PermissionSet protected by ManagedPolicyAttachment
        {{- $managedReady := get $managedPolicyReadyMap $managedAnnotationKey | default false }}
        {{- if and $permissionSetReady $managedReady }}

---

apiVersion: protection.crossplane.io/v1beta1
kind: Usage
metadata:
  name: {{ printf "of-%s-by-%s" $permissionSetResourceName $managedResourceName }}
  annotations:
    {{ setResourceNameAnnotation (printf "%s-usage" $managedAnnotationKey) }}
spec:
  replayDeletion: true
  of:
    apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
    kind: PermissionSet
    resourceRef:
      name: {{ $permissionSetResourceName }}
  by:
    apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
    kind: ManagedPolicyAttachment
    resourceRef:
      name: {{ $managedResourceName }}

        {{- end }}
      {{- end }}
    {{- end }}

    {{- range $customerPolicy := $customerManagedPolicies }}
      {{- if $customerPolicy }}
        {{- /* Use policy name as slug: MyCustomPolicy -> mycustompolicy */}}
        {{- $policySlug := regexReplaceAll "[^a-z0-9-]" (lower $customerPolicy.name) "" }}
        {{- $customerResourceName := printf "%s-customer-%s" $permissionSetResourceName $policySlug }}
        {{- $customerAnnotationKey := printf "permission-set-customer-managed-policy-%s-%s" $permissionSetName $policySlug }}

---

apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
kind: CustomerManagedPolicyAttachment
metadata:
  name: {{ $customerResourceName }}
  annotations:
    {{ setResourceNameAnnotation $customerAnnotationKey }}
  labels:
    {{- toYaml $permissionSetLabels | nindent 4 }}
spec:
  managementPolicies: {{ toYaml $psMgmtPolicies | nindent 4 }}
  forProvider:
    instanceArn: {{ $identityCenterInstanceArn }}
    permissionSetArnRef:
      name: {{ $permissionSetResourceName }}
    customerManagedPolicyReference:
      name: {{ $customerPolicy.name }}
      {{- if $customerPolicy.path }}
      path: {{ $customerPolicy.path }}
      {{- end }}
    {{- if $region }}
    region: {{ $region }}
    {{- end }}
  providerConfigRef:
    kind: ProviderConfig
    name: {{ $providerConfigName }}

# Usage: PermissionSet protected by CustomerManagedPolicyAttachment
        {{- $customerReady := get $customerManagedReadyMap $customerAnnotationKey | default false }}
        {{- if and $permissionSetReady $customerReady }}

---

apiVersion: protection.crossplane.io/v1beta1
kind: Usage
metadata:
  name: {{ printf "of-%s-by-%s" $permissionSetResourceName $customerResourceName }}
  annotations:
    {{ setResourceNameAnnotation (printf "%s-usage" $customerAnnotationKey) }}
spec:
  replayDeletion: true
  of:
    apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
    kind: PermissionSet
    resourceRef:
      name: {{ $permissionSetResourceName }}
  by:
    apiVersion: ssoadmin.aws.m.upbound.io/v1beta1
    kind: CustomerManagedPolicyAttachment
    resourceRef:
      name: {{ $customerResourceName }}

        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{ end }}
